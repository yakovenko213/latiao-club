<!DOCTYPE html>
<html lang="uk">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Latiao Club | Premium Loyal System</title>
    <style>
        :root {
            --primary: #FF6B00;
            --primary-light: #FF8533;
            --dark: #1A1A1A;
            --bg: #F8F9FA;
            --card-bg: rgba(255, 255, 255, 0.85);
            --border: rgba(0, 0, 0, 0.05);
            --text-main: #2D2D2D;
            --text-muted: #757575;
            --shadow: 0 10px 30px rgba(0, 0, 0, 0.04);
            --glass: blur(12px) saturate(180%);
            --transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }

        [data-theme="dark"] {
            --bg: #0F0F0F;
            --card-bg: rgba(30, 30, 30, 0.8);
            --border: rgba(255, 255, 255, 0.05);
            --text-main: #EDEDED;
            --text-muted: #A0A0A0;
            --shadow: 0 10px 40px rgba(0, 0, 0, 0.3);
        }

        * { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Inter', -apple-system, sans-serif; }
        body { background: var(--bg); color: var(--text-main); transition: var(--transition); min-height: 100vh; overflow-x: hidden; }

        /* Utils */
        .hidden { display: none !important; }
        .glass { background: var(--card-bg); backdrop-filter: var(--glass); -webkit-backdrop-filter: var(--glass); border: 1px solid var(--border); border-radius: 20px; box-shadow: var(--shadow); }
        .container { max-width: 1200px; margin: 0 auto; padding: 20px; }
        .flex { display: flex; align-items: center; gap: 15px; }
        .grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); gap: 20px; }
        .btn { padding: 12px 24px; border-radius: 12px; border: none; font-weight: 600; cursor: pointer; transition: var(--transition); text-align: center; }
        .btn-primary { background: var(--primary); color: white; }
        .btn-primary:hover { background: var(--primary-light); transform: translateY(-2px); box-shadow: 0 5px 15px rgba(255, 107, 0, 0.3); }
        .btn-secondary { background: var(--dark); color: white; }
        .badge { padding: 5px 12px; border-radius: 20px; font-size: 12px; font-weight: 700; text-transform: uppercase; }

        /* Typography */
        h1, h2, h3 { font-weight: 800; letter-spacing: -0.5px; }
        .text-orange { color: var(--primary); }

        /* Animations */
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        .animate { animation: fadeIn 0.5s ease forwards; }

        /* Sidebar/Header */
        header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 30px; }
        .logo { font-size: 24px; font-weight: 900; letter-spacing: -1px; }

        /* Progress Bar */
        .progress-container { width: 100%; height: 8px; background: rgba(0,0,0,0.05); border-radius: 10px; margin: 15px 0; overflow: hidden; }
        .progress-bar { height: 100%; background: var(--primary); width: 0%; transition: width 1s ease; }

        /* Stats Card */
        .stat-card { padding: 25px; display: flex; flex-direction: column; gap: 10px; }
        .stat-val { font-size: 28px; font-weight: 800; }
        .stat-label { font-size: 14px; color: var(--text-muted); }

        /* Inputs */
        input, select, textarea { 
            width: 100%; padding: 12px 16px; border-radius: 10px; border: 1px solid var(--border); 
            background: var(--card-bg); color: var(--text-main); outline: none; transition: var(--transition);
        }
        input:focus { border-color: var(--primary); }

        /* Modal */
        .modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); backdrop-filter: blur(4px); display: flex; justify-content: center; align-items: center; z-index: 1000; }
        
        /* Form elements */
        .form-group { margin-bottom: 15px; }
        .form-label { display: block; margin-bottom: 8px; font-size: 14px; font-weight: 600; }

        /* Admin Table */
        .admin-table-container { overflow-x: auto; }
        table { width: 100%; border-collapse: collapse; margin-top: 20px; }
        th, td { text-align: left; padding: 15px; border-bottom: 1px solid var(--border); }
        th { color: var(--text-muted); font-size: 12px; text-transform: uppercase; }

        /* Responsive Mobile */
        @media (max-width: 768px) {
            .grid { grid-template-columns: 1fr; }
            .logo { font-size: 20px; }
        }
    </style>
</head>
<body data-theme="light">

    <div id="login-screen" class="container" style="max-width: 450px; margin-top: 10vh;">
        <div class="glass animate" style="padding: 40px; text-align: center;">
            <div class="logo" style="margin-bottom: 10px;">LATIAO <span class="text-orange">CLUB</span></div>
            <p style="color: var(--text-muted); margin-bottom: 30px;">–í–≤—ñ–π–¥—ñ—Ç—å –∑–∞ –Ω–æ–º–µ—Ä–æ–º —Ç–µ–ª–µ—Ñ–æ–Ω—É</p>
            <div class="form-group" style="text-align: left;">
                <label class="form-label">–¢–µ–ª–µ—Ñ–æ–Ω</label>
                <input type="text" id="login-phone" placeholder="099 123 45 67">
            </div>
            <button class="btn btn-primary" style="width: 100%; margin-top: 10px;" onclick="handleLogin()">–£–≤—ñ–π—Ç–∏</button>
            <button class="btn" style="margin-top: 20px; font-size: 13px; color: var(--text-muted);" onclick="showAdminLogin()">–í—Ö—ñ–¥ –¥–ª—è –ø–µ—Ä—Å–æ–Ω–∞–ª—É</button>
        </div>
    </div>

    <div id="birthday-modal" class="modal-overlay hidden">
        <div class="glass animate" style="padding: 30px; width: 90%; max-width: 400px;">
            <h3>–ü—Ä–∏–≤—ñ—Ç! üéÅ</h3>
            <p style="font-size: 14px; margin: 15px 0;">–ù–∞–º –≤–∞–∂–ª–∏–≤–æ –∑–Ω–∞—Ç–∏ –¥–∞—Ç—É —Ç–≤–æ–≥–æ –Ω–∞—Ä–æ–¥–∂–µ–Ω–Ω—è, —â–æ–± –¥–∞—Ä—É–≤–∞—Ç–∏ –æ—Å–æ–±–ª–∏–≤—ñ –±–æ–Ω—É—Å–∏.</p>
            <div class="form-group">
                <label class="form-label">–í–∞—à–µ —ñ–º'—è</label>
                <input type="text" id="set-name" placeholder="–Ü–≤–∞–Ω">
            </div>
            <div class="form-group">
                <label class="form-label">–î–∞—Ç–∞ –Ω–∞—Ä–æ–¥–∂–µ–Ω–Ω—è</label>
                <input type="date" id="set-dob">
            </div>
            <button class="btn btn-primary" style="width: 100%;" onclick="saveBirthday()">–ó–±–µ—Ä–µ–≥—Ç–∏ —Ç–∞ –ø–æ—á–∞—Ç–∏</button>
        </div>
    </div>

    <div id="client-app" class="hidden animate">
        <header class="container">
            <div class="logo">LATIAO <span class="text-orange">CLUB</span></div>
            <div class="flex">
                <span id="header-name" style="font-weight: 600;"></span>
                <button class="btn btn-secondary" style="padding: 8px 15px; font-size: 12px;" onclick="logout()">–í–∏–π—Ç–∏</button>
            </div>
        </header>

        <main class="container">
            <div class="grid" style="margin-bottom: 30px;">
                <div class="glass stat-card">
                    <span class="stat-label">–ó–∞–º–æ–≤–ª–µ–Ω—å</span>
                    <span class="stat-val" id="stat-orders">0</span>
                </div>
                <div class="glass stat-card">
                    <span class="stat-label">–í–∏—Ç—Ä–∞—á–µ–Ω–æ</span>
                    <span class="stat-val"><span id="stat-spent">0</span> <small>–≥—Ä–Ω</small></span>
                </div>
                <div class="glass stat-card">
                    <span class="stat-label">–ü–∞—á–æ–∫ –∑'—ó–¥–µ–Ω–æ</span>
                    <span class="stat-val" id="stat-packs">0</span>
                </div>
                <div class="glass stat-card">
                    <span class="stat-label">–í–∏ –∑ –Ω–∞–º–∏</span>
                    <span class="stat-val" id="stat-time" style="font-size: 16px; font-weight: 700;">0–¥ 0–≥ 0—Ö–≤</span>
                </div>
            </div>

            <div class="grid" style="grid-template-columns: 2fr 1fr; align-items: start;">
                <div style="display: flex; flex-direction: column; gap: 30px;">
                    <div class="glass" style="padding: 30px;">
                        <div class="flex" style="justify-content: space-between;">
                            <h3>–í–∞—à —Å—Ç–∞—Ç—É—Å: <span id="rank-name" class="text-orange">New</span></h3>
                            <span id="rank-badge" class="badge" style="background: #E0E0E0; color: #333;">NEW</span>
                        </div>
                        <div class="progress-container">
                            <div id="rank-progress" class="progress-bar"></div>
                        </div>
                        <div class="flex" style="justify-content: space-between; font-size: 14px;">
                            <span id="progress-spent">0 –≥—Ä–Ω</span>
                            <span id="next-rank-info" style="color: var(--text-muted);">–î–æ VIP —â–µ 5000 –≥—Ä–Ω</span>
                        </div>
                        <div id="rank-perks" style="margin-top: 20px; font-size: 14px; background: rgba(255,107,0,0.05); padding: 15px; border-radius: 12px;">
                            <b>–ë–æ–Ω—É—Å–∏ —Ä—ñ–≤–Ω—è:</b> <span id="rank-perks-text">–ó–Ω–∏–∂–∫–∞ 0%</span>
                        </div>
                    </div>

                    <div class="glass" style="padding: 30px;">
                        <h3 style="margin-bottom: 20px;">–í–∞—à—ñ –ø—Ä–æ–º–æ–∫–æ–¥–∏</h3>
                        <div id="promo-list" style="display: flex; flex-direction: column; gap: 15px;">
                            </div>
                    </div>

                    <div class="glass" style="padding: 30px; border-left: 5px solid #27AE60;">
                        <div class="flex" style="justify-content: space-between;">
                            <h3>–ë–µ–∑–∫–æ—à—Ç–æ–≤–Ω—ñ –¥–æ—Å—Ç–∞–≤–∫–∏</h3>
                            <span style="font-size: 24px; font-weight: 800;" id="free-delivery-count">0</span>
                        </div>
                        <p style="font-size: 14px; color: var(--text-muted); margin-top: 10px;">
                            –î–æ—Å—Ç—É–ø–Ω–æ —É —Ü—å–æ–º—É –º—ñ—Å—è—Ü—ñ. <span id="delivery-warning" class="hidden" style="color: #E74C3C; font-weight: 700;">‚ö† –ó–≥–æ—Ä—è—Ç—å –∑–∞ 3 –¥–Ω—ñ!</span>
                        </p>
                    </div>
                </div>

                <div style="display: flex; flex-direction: column; gap: 30px;">
                    <div class="glass" style="padding: 25px;">
                        <h4 style="margin-bottom: 15px;">–ü—ñ–¥–ø–∏—Å–∫–∏</h4>
                        <div class="form-group flex" style="gap: 10px;">
                            <input type="checkbox" id="sub-supply" style="width: auto;" onchange="updateSubs()">
                            <label style="font-size: 14px;">–ù–æ–≤—ñ –ø–æ—Å—Ç–∞–≤–∫–∏</label>
                        </div>
                        <div class="form-group flex" style="gap: 10px;">
                            <input type="checkbox" id="sub-promo" style="width: auto;" onchange="updateSubs()">
                            <label style="font-size: 14px;">–ê–∫—Ü—ñ—ó —Ç–∞ –Ω–æ–≤–∏–Ω–∫–∏</label>
                        </div>
                    </div>

                    <div class="glass" style="padding: 25px;">
                        <h4 style="margin-bottom: 15px;">–ü—ñ–¥—Ç—Ä–∏–º–∫–∞</h4>
                        <input type="text" id="support-subject" placeholder="–¢–µ–º–∞" style="margin-bottom: 10px; font-size: 13px;">
                        <textarea id="support-msg" placeholder="–û–ø–∏—à—ñ—Ç—å –ø—Ä–æ–±–ª–µ–º—É..." style="height: 80px; font-size: 13px; margin-bottom: 10px;"></textarea>
                        <button class="btn btn-secondary" style="width: 100%; font-size: 13px;" onclick="sendSupport()">–ù–∞–¥—ñ—Å–ª–∞—Ç–∏</button>
                    </div>

                    <div class="glass" style="padding: 25px;">
                        <h4 style="margin-bottom: 15px;">–ü–æ—Å–∏–ª–∞–Ω–Ω—è</h4>
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px;">
                            <a href="#" class="btn btn-secondary" style="font-size: 11px; text-decoration: none;">Instagram</a>
                            <a href="#" class="btn btn-secondary" style="font-size: 11px; text-decoration: none; background: #0088cc;">Telegram</a>
                            <a href="#" class="btn btn-secondary" style="font-size: 11px; text-decoration: none; background: #000;">TikTok</a>
                            <a href="#" class="btn btn-primary" style="font-size: 11px; text-decoration: none;">–°–∞–π—Ç</a>
                        </div>
                        <a href="#" class="btn btn-secondary" style="width: 100%; margin-top: 10px; font-size: 11px; text-decoration: none; background: #444;">–û–ø—Ç–æ–≤–∏–π –∫–∞–Ω–∞–ª</a>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <div id="admin-login-screen" class="container hidden" style="max-width: 400px; margin-top: 15vh;">
        <div class="glass animate" style="padding: 40px;">
            <h2 style="margin-bottom: 20px;">–í—Ö—ñ–¥ –≤ –ê–¥–º—ñ–Ω-–ø–∞–Ω–µ–ª—å</h2>
            <div class="form-group">
                <input type="password" id="admin-pass-input" placeholder="–ü–∞—Ä–æ–ª—å">
            </div>
            <button class="btn btn-primary" style="width: 100%;" onclick="handleAdminLogin()">–£–≤—ñ–π—Ç–∏</button>
            <button class="btn" style="width: 100%; margin-top: 10px; font-size: 13px;" onclick="showClientLogin()">–ù–∞–∑–∞–¥ –¥–æ –∫–ª—É–±—É</button>
        </div>
    </div>

    <div id="admin-panel" class="hidden animate">
        <header class="container" style="border-bottom: 1px solid var(--border); padding-bottom: 20px;">
            <div class="logo">LATIAO <span class="text-orange">ADMIN</span></div>
            <div class="flex">
                <button class="btn" onclick="toggleTheme()" id="theme-toggle">üåô</button>
                <button class="btn btn-secondary" onclick="logout()">–í–∏—Ö—ñ–¥</button>
            </div>
        </header>

        <main class="container">
            <div class="flex" style="margin-bottom: 30px; border-bottom: 1px solid var(--border); padding-bottom: 10px;">
                <button class="btn" style="background: none; color: var(--text-main);" onclick="showAdminTab('customers')">–ö–ª—ñ—î–Ω—Ç–∏</button>
                <button class="btn" style="background: none; color: var(--text-main);" onclick="showAdminTab('promos')">–ü—Ä–æ–º–æ–∫–æ–¥–∏</button>
                <button class="btn" style="background: none; color: var(--text-main);" onclick="showAdminTab('analytics')">–ê–Ω–∞–ª—ñ—Ç–∏–∫–∞</button>
                <button class="btn" style="background: none; color: var(--text-main);" onclick="showAdminTab('settings')">–ù–∞–ª–∞—à—Ç—É–≤–∞–Ω–Ω—è</button>
            </div>

            <div id="tab-customers" class="admin-tab">
                <div class="flex" style="justify-content: space-between;">
                    <h3>–£–ø—Ä–∞–≤–ª—ñ–Ω–Ω—è –∫–ª—ñ—î–Ω—Ç–∞–º–∏</h3>
                </div>
                <div class="glass" style="margin-top: 20px; padding: 20px;">
                    <div class="admin-table-container">
                        <table>
                            <thead>
                                <tr>
                                    <th>–ö–ª—ñ—î–Ω—Ç</th>
                                    <th>–í–∏—Ç—Ä–∞—Ç–∏</th>
                                    <th>–î–æ—Å—Ç–∞–≤–∫–∏</th>
                                    <th>–†—ñ–≤–µ–Ω—å</th>
                                    <th>–î—ñ—ó</th>
                                </tr>
                            </thead>
                            <tbody id="admin-user-table-body">
                                </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <div id="tab-promos" class="admin-tab hidden">
                <div class="grid" style="grid-template-columns: 1fr 2fr;">
                    <div class="glass" style="padding: 25px;">
                        <h4 style="margin-bottom: 15px;">–°—Ç–≤–æ—Ä–∏—Ç–∏ –ø—Ä–æ–º–æ–∫–æ–¥</h4>
                        <div class="form-group">
                            <label class="form-label">–ö–æ–¥</label>
                            <input type="text" id="new-promo-code" placeholder="NEW2024">
                        </div>
                        <div class="form-group">
                            <label class="form-label">–¢–∏–ø</label>
                            <select id="new-promo-type">
                                <option value="discount">–ó–Ω–∏–∂–∫–∞ %</option>
                                <option value="delivery">–ë–µ–∑–∫–æ—à—Ç–æ–≤–Ω–∞ –¥–æ—Å—Ç–∞–≤–∫–∞</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label class="form-label">–ó–Ω–∞—á–µ–Ω–Ω—è / –ú—ñ–Ω. —Å—É–º–∞</label>
                            <input type="number" id="new-promo-val" placeholder="10">
                        </div>
                        <button class="btn btn-primary" style="width: 100%;" onclick="createPromo()">–°—Ç–≤–æ—Ä–∏—Ç–∏</button>
                    </div>
                    <div class="glass" style="padding: 25px;">
                        <h4 style="margin-bottom: 15px;">–í—Å—ñ –ø—Ä–æ–º–æ–∫–æ–¥–∏</h4>
                        <div id="admin-promo-list"></div>
                    </div>
                </div>
            </div>

            <div id="tab-analytics" class="admin-tab hidden">
                <div class="grid">
                    <div class="glass stat-card">
                        <span class="stat-label">–í—Å—å–æ–≥–æ –∫–ª—ñ—î–Ω—Ç—ñ–≤</span>
                        <span class="stat-val" id="total-customers">0</span>
                    </div>
                    <div class="glass stat-card">
                        <span class="stat-label">–ó–∞–≥–∞–ª—å–Ω–∏–π –æ–±–æ—Ä–æ—Ç</span>
                        <span class="stat-val" id="total-revenue">0 –≥—Ä–Ω</span>
                    </div>
                    <div class="glass stat-card">
                        <span class="stat-label">–í–∏–∫–æ—Ä–∏—Å—Ç–∞–Ω–æ –ø—Ä–æ–º–æ</span>
                        <span class="stat-val" id="total-promos-used">0</span>
                    </div>
                </div>
                <div class="glass" style="margin-top: 30px; padding: 30px;">
                    <h3>–¢–û–ü –ö–ª—ñ—î–Ω—Ç—ñ–≤</h3>
                    <div id="top-customers-list"></div>
                </div>
            </div>

            <div id="tab-settings" class="admin-tab hidden">
                <div class="glass" style="max-width: 600px; padding: 30px;">
                    <h3>–ù–∞–ª–∞—à—Ç—É–≤–∞–Ω–Ω—è Telegram</h3>
                    <div class="form-group">
                        <label class="form-label">Telegram Bot Token</label>
                        <input type="text" id="tg-token" placeholder="7123456:ABC-DEF...">
                    </div>
                    <button class="btn btn-primary" onclick="saveSettings()">–ó–±–µ—Ä–µ–≥—Ç–∏ –Ω–∞–ª–∞—à—Ç—É–≤–∞–Ω–Ω—è</button>
                </div>
            </div>
        </main>
    </div>

    <div id="edit-user-modal" class="modal-overlay hidden">
        <div class="glass animate" style="padding: 30px; width: 95%; max-width: 600px; max-height: 90vh; overflow-y: auto;">
            <div class="flex" style="justify-content: space-between; margin-bottom: 20px;">
                <h3 id="edit-user-title">–†–µ–¥–∞–≥—É–≤–∞–Ω–Ω—è –∫–ª—ñ—î–Ω—Ç–∞</h3>
                <button onclick="closeModal('edit-user-modal')">‚úñ</button>
            </div>
            
            <div class="grid" style="grid-template-columns: 1fr 1fr;">
                <div>
                    <div class="form-group">
                        <label class="form-label">–Ü–º'—è</label>
                        <input type="text" id="edit-user-name">
                    </div>
                    <div class="form-group">
                        <label class="form-label">–í–∏—Ç—Ä–∞—Ç–∏ (–≥—Ä–Ω)</label>
                        <input type="number" id="edit-user-spent">
                    </div>
                    <div class="form-group">
                        <label class="form-label">–ü–∞—á–∫–∏ (—à—Ç)</label>
                        <input type="number" id="edit-user-packs">
                    </div>
                    <div class="form-group">
                        <label class="form-label">–ó–∞–º–æ–≤–ª–µ–Ω–Ω—è (—à—Ç)</label>
                        <input type="number" id="edit-user-orders">
                    </div>
                </div>
                <div>
                    <div class="form-group">
                        <label class="form-label">–ë–µ–∑–∫–æ—à—Ç–æ–≤–Ω—ñ –¥–æ—Å—Ç–∞–≤–∫–∏</label>
                        <input type="number" id="edit-user-deliveries">
                    </div>
                    <div class="form-group">
                        <label class="form-label">Telegram ID</label>
                        <input type="text" id="edit-user-tg">
                    </div>
                    <div class="form-group">
                        <label class="form-label">–°—Ç–∞—Ç—É—Å</label>
                        <select id="edit-user-status">
                            <option value="active">–ê–∫—Ç–∏–≤–Ω–∏–π</option>
                            <option value="blocked">–ó–∞–±–ª–æ–∫–æ–≤–∞–Ω–∏–π</option>
                        </select>
                    </div>
                </div>
            </div>

            <div style="margin-top: 20px; display: flex; gap: 10px;">
                <button class="btn btn-primary" onclick="saveUserEdit()">–ó–±–µ—Ä–µ–≥—Ç–∏ –∑–º—ñ–Ω–∏</button>
                <button class="btn btn-secondary" id="tg-msg-btn">–ù–∞–ø–∏—Å–∞—Ç–∏ –≤ Telegram</button>
            </div>
        </div>
    </div>

    <script>
        // --- INITIAL DATA & MODELS ---
        const RANKS = [
            { id: 'new', name: 'New', min: 0, perks: '–ó–Ω–∏–∂–∫–∞ 0%', color: '#95A5A6' },
            { id: 'regular', name: 'Regular', min: 1000, perks: '–ó–Ω–∏–∂–∫–∞ 3% + 1 –¥–æ—Å—Ç.', color: '#3498DB' },
            { id: 'vip', name: 'VIP', min: 5000, perks: '–ó–Ω–∏–∂–∫–∞ 7% + 3 –¥–æ—Å—Ç.', color: '#9B59B6' },
            { id: 'legend', name: 'Legend', min: 15000, perks: '–ó–Ω–∏–∂–∫–∞ 15% + –ë–µ–∑–ª—ñ–º –¥–æ—Å—Ç.', color: '#F1C40F' }
        ];

        let state = {
            users: JSON.parse(localStorage.getItem('lc_users')) || [],
            promos: JSON.parse(localStorage.getItem('lc_promos')) || [
                { id: 1, code: 'WELCOME', type: 'discount', val: 10, min: 200, status: 'active' }
            ],
            settings: JSON.parse(localStorage.getItem('lc_settings')) || {
                tgToken: '',
                theme: 'light'
            },
            currentUserPhone: localStorage.getItem('lc_current_user') || null
        };

        // --- CORE FUNCTIONS ---
        function saveState() {
            localStorage.setItem('lc_users', JSON.stringify(state.users));
            localStorage.setItem('lc_promos', JSON.stringify(state.promos));
            localStorage.setItem('lc_settings', JSON.stringify(state.settings));
        }

        function calculateRank(spent) {
            let current = RANKS[0];
            for (let i = RANKS.length - 1; i >= 0; i--) {
                if (spent >= RANKS[i].min) {
                    current = RANKS[i];
                    break;
                }
            }
            let nextIndex = RANKS.indexOf(current) + 1;
            let next = nextIndex < RANKS.length ? RANKS[nextIndex] : null;
            
            let progress = 0;
            if (next) {
                progress = ((spent - current.min) / (next.min - current.min)) * 100;
            } else {
                progress = 100;
            }

            return { current, next, progress };
        }

        // --- AUTH ---
        function handleLogin() {
            const phone = document.getElementById('login-phone').value.trim();
            if (!phone) return alert('–í–≤–µ–¥—ñ—Ç—å —Ç–µ–ª–µ—Ñ–æ–Ω');

            let user = state.users.find(u => u.phone === phone);
            if (!user) {
                user = {
                    phone,
                    name: '',
                    lastName: '',
                    dob: '',
                    spent: 0,
                    orders: 0,
                    packs: 0,
                    deliveries: 0,
                    status: 'active',
                    joinedAt: new Date().toISOString(),
                    subsSupply: true,
                    subsPromo: true,
                    tgId: '',
                    promos: ['WELCOME']
                };
                state.users.push(user);
                saveState();
            }

            if (user.status === 'blocked') return alert('–í–∞—à –∞–∫–∫–∞—É–Ω—Ç –∑–∞–±–ª–æ–∫–æ–≤–∞–Ω–æ');

            state.currentUserPhone = phone;
            localStorage.setItem('lc_current_user', phone);
            
            if (!user.dob) {
                document.getElementById('birthday-modal').classList.remove('hidden');
            } else {
                initApp();
            }
        }

        function saveBirthday() {
            const name = document.getElementById('set-name').value.trim();
            const dob = document.getElementById('set-dob').value;
            if (!name || !dob) return alert('–ó–∞–ø–æ–≤–Ω—ñ—Ç—å –≤—Å—ñ –ø–æ–ª—è');

            let user = state.users.find(u => u.phone === state.currentUserPhone);
            user.name = name;
            user.dob = dob;
            saveState();
            
            document.getElementById('birthday-modal').classList.add('hidden');
            initApp();
        }

        function logout() {
            state.currentUserPhone = null;
            localStorage.removeItem('lc_current_user');
            location.reload();
        }

        // --- CLIENT UI ---
        function initApp() {
            const user = state.users.find(u => u.phone === state.currentUserPhone);
            if (!user) return showClientLogin();

            document.getElementById('login-screen').classList.add('hidden');
            document.getElementById('admin-panel').classList.add('hidden');
            document.getElementById('client-app').classList.remove('hidden');

            document.getElementById('header-name').innerText = user.name;
            document.getElementById('stat-orders').innerText = user.orders;
            document.getElementById('stat-spent').innerText = user.spent;
            document.getElementById('stat-packs').innerText = user.packs;
            
            // Time counting
            const joined = new Date(user.joinedAt);
            setInterval(() => {
                const now = new Date();
                const diff = now - joined;
                const days = Math.floor(diff / (1000 * 60 * 60 * 24));
                const hours = Math.floor((diff % (1000 * 60 * 60 * 24)) / (1000 * 60 * 60));
                const mins = Math.floor((diff % (1000 * 60 * 60)) / (1000 * 60));
                const secs = Math.floor((diff % (1000 * 60)) / 1000);
                document.getElementById('stat-time').innerText = `${days}–¥ ${hours}–≥ ${mins}—Ö–≤ ${secs}—Å`;
            }, 1000);

            // Rank UI
            const rankData = calculateRank(user.spent);
            document.getElementById('rank-name').innerText = rankData.current.name;
            document.getElementById('rank-badge').innerText = rankData.current.name.toUpperCase();
            document.getElementById('rank-badge').style.background = rankData.current.color;
            document.getElementById('rank-progress').style.width = rankData.progress + '%';
            document.getElementById('progress-spent').innerText = user.spent + ' –≥—Ä–Ω';
            
            if (rankData.next) {
                document.getElementById('next-rank-info').innerText = `–î–æ ${rankData.next.name} —â–µ ${rankData.next.min - user.spent} –≥—Ä–Ω`;
            } else {
                document.getElementById('next-rank-info').innerText = `–ú–∞–∫—Å–∏–º–∞–ª—å–Ω–∏–π —Å—Ç–∞—Ç—É—Å!`;
            }
            document.getElementById('rank-perks-text').innerText = rankData.current.perks;

            // Deliveries
            document.getElementById('free-delivery-count').innerText = user.deliveries;
            const now = new Date();
            const lastDay = new Date(now.getFullYear(), now.getMonth() + 1, 0).getDate();
            if (lastDay - now.getDate() <= 3) {
                document.getElementById('delivery-warning').classList.remove('hidden');
            }

            // Promos
            renderClientPromos(user);

            // Checkboxes
            document.getElementById('sub-supply').checked = user.subsSupply;
            document.getElementById('sub-promo').checked = user.subsPromo;
        }

        function renderClientPromos(user) {
            const list = document.getElementById('promo-list');
            list.innerHTML = '';
            
            if (!user.promos || user.promos.length === 0) {
                list.innerHTML = '<p style="font-size: 13px; color: var(--text-muted);">–ü—Ä–æ–º–æ–∫–æ–¥—ñ–≤ –ø–æ–∫–∏ –Ω–µ–º–∞—î</p>';
                return;
            }

            user.promos.forEach(code => {
                const promo = state.promos.find(p => p.code === code);
                if (promo) {
                    const card = document.createElement('div');
                    card.className = 'flex';
                    card.style = 'justify-content: space-between; padding: 12px; border-radius: 10px; background: rgba(0,0,0,0.03);';
                    card.innerHTML = `
                        <div>
                            <div style="font-weight: 700; color: var(--primary);">${promo.code}</div>
                            <div style="font-size: 11px; color: var(--text-muted);">${promo.type === 'discount' ? promo.val + '% –∑–Ω–∏–∂–∫–∞' : '–ë–µ–∑–∫–æ—à—Ç–æ–≤–Ω–∞ –¥–æ—Å—Ç–∞–≤–∫–∞'} ‚Ä¢ –í—ñ–¥ ${promo.min}–≥—Ä–Ω</div>
                        </div>
                        <span class="badge" style="background: ${promo.status === 'active' ? '#27AE60' : '#E74C3C'}; color: white;">${promo.status}</span>
                    `;
                    list.appendChild(card);
                }
            });
        }

        function updateSubs() {
            const user = state.users.find(u => u.phone === state.currentUserPhone);
            user.subsSupply = document.getElementById('sub-supply').checked;
            user.subsPromo = document.getElementById('sub-promo').checked;
            saveState();
        }

        function sendSupport() {
            const subj = document.getElementById('support-subject').value;
            const msg = document.getElementById('support-msg').value;
            if (!subj || !msg) return alert('–ó–∞–ø–æ–≤–Ω—ñ—Ç—å –ø–æ–ª—è');
            alert('–í–∞—à –∑–∞–ø–∏—Ç –Ω–∞–¥—ñ—Å–ª–∞–Ω–æ! –ú–∏ –≤—ñ–¥–ø–æ–≤—ñ–º–æ –Ω–∞–π–±–ª–∏–∂—á–∏–º —á–∞—Å–æ–º.');
            document.getElementById('support-subject').value = '';
            document.getElementById('support-msg').value = '';
        }

        // --- ADMIN UI ---
        function showAdminLogin() {
            document.getElementById('login-screen').classList.add('hidden');
            document.getElementById('admin-login-screen').classList.remove('hidden');
        }

        function showClientLogin() {
            document.getElementById('admin-login-screen').classList.add('hidden');
            document.getElementById('login-screen').classList.remove('hidden');
        }

        function handleAdminLogin() {
            const pass = document.getElementById('admin-pass-input').value;
            if (pass === 'latiao_admin') {
                initAdmin();
            } else {
                alert('–ù–µ–≤—ñ—Ä–Ω–∏–π –ø–∞—Ä–æ–ª—å');
            }
        }

        function initAdmin() {
            document.getElementById('admin-login-screen').classList.add('hidden');
            document.getElementById('admin-panel').classList.remove('hidden');
            showAdminTab('customers');
            applyTheme();
        }

        function showAdminTab(tab) {
            document.querySelectorAll('.admin-tab').forEach(el => el.classList.add('hidden'));
            document.getElementById('tab-' + tab).classList.remove('hidden');
            
            if (tab === 'customers') renderAdminUsers();
            if (tab === 'promos') renderAdminPromos();
            if (tab === 'analytics') renderAnalytics();
            if (tab === 'settings') {
                document.getElementById('tg-token').value = state.settings.tgToken;
            }
        }

        function renderAdminUsers() {
            const body = document.getElementById('admin-user-table-body');
            body.innerHTML = '';
            state.users.forEach(user => {
                const tr = document.createElement('tr');
                const rank = calculateRank(user.spent).current.name;
                tr.innerHTML = `
                    <td>
                        <div style="font-weight: 700;">${user.name || '–ê–Ω–æ–Ω—ñ–º'}</div>
                        <div style="font-size: 11px; color: var(--text-muted);">${user.phone}</div>
                    </td>
                    <td>${user.spent} <small>–≥—Ä–Ω</small></td>
                    <td>${user.deliveries}</td>
                    <td><span class="badge" style="background: #EEE;">${rank}</span></td>
                    <td>
                        <button class="btn btn-secondary" style="padding: 5px 10px; font-size: 10px;" onclick="openEditUser('${user.phone}')">–†–µ–¥–∞–≥—É–≤–∞—Ç–∏</button>
                    </td>
                `;
                body.appendChild(tr);
            });
        }

        let editingPhone = null;
        function openEditUser(phone) {
            editingPhone = phone;
            const user = state.users.find(u => u.phone === phone);
            document.getElementById('edit-user-title').innerText = `–ö–ª—ñ—î–Ω—Ç: ${user.phone}`;
            document.getElementById('edit-user-name').value = user.name;
            document.getElementById('edit-user-spent').value = user.spent;
            document.getElementById('edit-user-packs').value = user.packs;
            document.getElementById('edit-user-orders').value = user.orders;
            document.getElementById('edit-user-deliveries').value = user.deliveries;
            document.getElementById('edit-user-tg').value = user.tgId;
            document.getElementById('edit-user-status').value = user.status;
            
            document.getElementById('tg-msg-btn').onclick = () => sendTgMessage(user.tgId);
            document.getElementById('edit-user-modal').classList.remove('hidden');
        }

        function saveUserEdit() {
            const user = state.users.find(u => u.phone === editingPhone);
            user.name = document.getElementById('edit-user-name').value;
            user.spent = parseFloat(document.getElementById('edit-user-spent').value);
            user.packs = parseInt(document.getElementById('edit-user-packs').value);
            user.orders = parseInt(document.getElementById('edit-user-orders').value);
            user.deliveries = parseInt(document.getElementById('edit-user-deliveries').value);
            user.tgId = document.getElementById('edit-user-tg').value;
            user.status = document.getElementById('edit-user-status').value;
            
            saveState();
            closeModal('edit-user-modal');
            renderAdminUsers();
        }

        function renderAdminPromos() {
            const list = document.getElementById('admin-promo-list');
            list.innerHTML = '';
            state.promos.forEach(promo => {
                const card = document.createElement('div');
                card.className = 'glass';
                card.style = 'padding: 15px; margin-bottom: 10px; display: flex; justify-content: space-between; align-items: center;';
                card.innerHTML = `
                    <div>
                        <b>${promo.code}</b> <small>(${promo.type})</small><br>
                        <span style="font-size: 12px; color: var(--text-muted);">–ó–Ω–∞—á–µ–Ω–Ω—è: ${promo.val} | –í—ñ–¥ ${promo.min}–≥—Ä–Ω</span>
                    </div>
                    <button class="btn btn-secondary" style="background: #C0392B; padding: 5px 10px;" onclick="deletePromo(${promo.id})">–í–∏–¥–∞–ª–∏—Ç–∏</button>
                `;
                list.appendChild(card);
            });
        }

        function createPromo() {
            const code = document.getElementById('new-promo-code').value.trim();
            const type = document.getElementById('new-promo-type').value;
            const val = parseFloat(document.getElementById('new-promo-val').value);
            if (!code || isNaN(val)) return alert('–ó–∞–ø–æ–≤–Ω—ñ—Ç—å –ø–æ–ª—è');
            
            state.promos.push({
                id: Date.now(),
                code, type, val, min: val * 10, status: 'active'
            });
            saveState();
            renderAdminPromos();
        }

        function deletePromo(id) {
            state.promos = state.promos.filter(p => p.id !== id);
            saveState();
            renderAdminPromos();
        }

        function renderAnalytics() {
            const totalUsers = state.users.length;
            const totalRevenue = state.users.reduce((sum, u) => sum + u.spent, 0);
            document.getElementById('total-customers').innerText = totalUsers;
            document.getElementById('total-revenue').innerText = totalRevenue + ' –≥—Ä–Ω';
            
            const topBody = document.getElementById('top-customers-list');
            topBody.innerHTML = '';
            [...state.users].sort((a,b) => b.spent - a.spent).slice(0, 5).forEach((u, i) => {
                const item = document.createElement('div');
                item.style = 'padding: 10px; border-bottom: 1px solid var(--border);';
                item.innerHTML = `${i+1}. <b>${u.name || u.phone}</b> ‚Äî ${u.spent} –≥—Ä–Ω`;
                topBody.appendChild(item);
            });
        }

        function saveSettings() {
            state.settings.tgToken = document.getElementById('tg-token').value;
            saveState();
            alert('–ù–∞–ª–∞—à—Ç—É–≤–∞–Ω–Ω—è –∑–±–µ—Ä–µ–∂–µ–Ω–æ');
        }

        async function sendTgMessage(chatId) {
            if (!state.settings.tgToken) return alert('–°–ø–æ—á–∞—Ç–∫—É –Ω–∞–ª–∞—à—Ç—É–π—Ç–µ Bot Token');
            if (!chatId) return alert('ID –∫–ª—ñ—î–Ω—Ç–∞ –Ω–µ –≤–∫–∞–∑–∞–Ω–æ');
            
            const text = prompt('–í–≤–µ–¥—ñ—Ç—å –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω–Ω—è –¥–ª—è –∫–ª—ñ—î–Ω—Ç–∞:');
            if (!text) return;

            const url = `https://api.telegram.org/bot${state.settings.tgToken}/sendMessage?chat_id=${chatId}&text=${encodeURIComponent(text)}`;
            
            try {
                await fetch(url);
                alert('–ü–æ–≤—ñ–¥–æ–º–ª–µ–Ω–Ω—è –Ω–∞–¥—ñ—Å–ª–∞–Ω–æ!');
            } catch (e) {
                alert('–ü–æ–º–∏–ª–∫–∞ –Ω–∞–¥—Å–∏–ª–∞–Ω–Ω—è: ' + e.message);
            }
        }

        // --- HELPERS ---
        function toggleTheme() {
            state.settings.theme = state.settings.theme === 'light' ? 'dark' : 'light';
            saveState();
            applyTheme();
        }

        function applyTheme() {
            document.body.setAttribute('data-theme', state.settings.theme);
            document.getElementById('theme-toggle').innerText = state.settings.theme === 'light' ? 'üåô' : '‚òÄÔ∏è';
        }

        function closeModal(id) { document.getElementById(id).classList.add('hidden'); }

        // --- INIT ---
        window.onload = () => {
            if (state.currentUserPhone) {
                initApp();
            }
            applyTheme();
        };

    </script>
</body>
</html>
